<!doctype html>
<html lang="sk">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Aktu√°lne hr√°me</title>
  <meta name="color-scheme" content="dark light" />
  <style>
    :root { color-scheme: dark; }
    * { box-sizing: border-box; }
    body{
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background:#0e0e0e; color:#eaeaea; margin:0; padding:2rem;
    }
    .wrap{max-width:920px;margin:0 auto}
    h1{margin:0 0 1rem 0;font-size:clamp(2rem,3.5vw,3rem)}
    p.muted{color:#9aa0a6;margin:.25rem 0 1.25rem 0}
    .row{display:flex;gap:.8rem;align-items:center;flex-wrap:wrap}
    button{
      padding:.9rem 1.3rem;border:0;border-radius:14px;
      background:#2a2a2a;color:#fff;font-weight:600;font-size:1.05rem;
      cursor:pointer; transition:.15s ease background;
    }
    button:hover{background:#333}
    button:disabled{opacity:.65; cursor:not-allowed}
    .state{color:#9aa0a6; min-height:1lh}
    .card{
      margin-top:1.25rem;padding:1.1rem 1.3rem;border-radius:18px;
      background:#161616; box-shadow:0 8px 28px rgba(0,0,0,.35);
    }
    .song{font-size:clamp(1.2rem,2.5vw,1.7rem);font-weight:700}
    .meta{color:#9aa0a6;margin-top:.35rem}
    .err{color:#ffb4b4}
    a { color:#a7c7ff; text-decoration:none }
    a:hover { text-decoration:underline }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Aktu√°lne hr√°me</h1>
    <p class="muted">
      Tlaƒçidlo zavol√° ≈æiv√© API na Renderi a zobraz√≠ pr√°ve hran√∫ skladbu s odhadom poƒç√∫vanosti.
    </p>

    <div class="row">
      <button id="btn">Zisti≈• teraz</button>
      <div id="state" class="state"></div>
    </div>

    <div id="card" class="card" hidden>
      <div id="song" class="song">‚Äî</div>
      <div id="meta" class="meta">‚Äî</div>
      <pre id="debug" class="meta" style="white-space:pre-wrap; margin-top:.6rem; display:none"></pre>
    </div>

    <div id="err" class="card err" hidden></div>
  </div>

  <script>
    // ----- nastavenia --------------------------------------------------------
    const API_BASE   = 'https://melody-now.onrender.com';
    const API_NOW    = API_BASE + '/now';
    const API_HEALTH = API_BASE + '/health';

    const btn   = document.getElementById('btn');
    const state = document.getElementById('state');
    const card  = document.getElementById('card');
    const song  = document.getElementById('song');
    const meta  = document.getElementById('meta');
    const errEl = document.getElementById('err');
    const dbgEl = document.getElementById('debug');

    const params = new URLSearchParams(location.search);
    const WANT_DEBUG = params.get('debug') === '1';

    function escapeHtml(s){
      return String(s).replace(/[&<>"']/g, m => ({
        '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
      }[m]));
    }

    async function sleep(ms){ return new Promise(r=>setTimeout(r,ms)); }

    async function fetchJson(url, timeoutMs=20000){
      const ctrl = new AbortController();
      const id = setTimeout(() => ctrl.abort(), timeoutMs);
      try {
        const r = await fetch(url, {
          cache: 'no-store',
          signal: ctrl.signal,
          headers: { 'Accept':'application/json', 'Cache-Control':'no-store' }
        });
        if (!r.ok) throw new Error(`HTTP ${r.status}`);
        return await r.json();
      } finally { clearTimeout(id); }
    }

    async function warmUp(){
      // nen√∫ten√© "≈°tuchnutie" Renderu ‚Äì ignorujeme chybu
      try { await fetch(API_HEALTH, { cache:'no-store' }); } catch {}
    }

    async function loadNow(){
      btn.disabled = true;
      errEl.hidden = true; card.hidden = true;
      dbgEl.style.display = 'none';
      state.textContent = 'Naƒç√≠tavam‚Ä¶';

      // prebudenie Render-u pri cold starte
      await warmUp();

      const ts = Date.now(); // kƒæ√∫ƒçov√© ‚Äì rozkmit r√Ωchleho jitteru na serveri
      const url = API_NOW + '?ts=' + ts + (WANT_DEBUG ? '&debug=1' : '');

      try {
        let data;
        try {
          data = await fetchJson(url, 45000);
        } catch {
          // jeden jemn√Ω retry po 2s (po cold starte)
          await sleep(2000);
          data = await fetchJson(url, 45000);
        }

        if (data.error) throw new Error(data.error);

        song.innerHTML = `üéµ <strong>${escapeHtml(data.artist)}</strong> ‚Äî ${escapeHtml(data.title)}`;
        meta.textContent = `${data.date} ${data.time} ¬∑ odhad poƒç√∫vanosti: ${Number(data.listeners||0).toLocaleString('sk-SK')}`;

        if (WANT_DEBUG && data._dbg){
          dbgEl.textContent = `debug: ${JSON.stringify(data._dbg, null, 2)}`;
          dbgEl.style.display = 'block';
        }

        card.hidden = false;
        state.textContent = 'Hotovo.';
      } catch (e) {
        errEl.hidden = false;
        errEl.innerHTML = `Chyba: ${escapeHtml(e.message)}<br>
          <span class="meta">Sk√∫s znova, alebo otvor API priamo:
          <a href="${url}" target="_blank" rel="noopener">${url}</a></span>`;
        state.textContent = 'Chyba.';
      } finally {
        btn.disabled = false;
        // po chv√≠li status st√≠≈°i≈•
        setTimeout(() => { if (state.textContent === 'Hotovo.') state.textContent = ''; }, 1200);
      }
    }

    btn.addEventListener('click', loadNow);
    window.addEventListener('DOMContentLoaded', loadNow);
  </script>
</body>
</html>
